%% Dokumenteinstellungen %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\documentclass[a4paper,oneside,12pt,ngerman]{scrartcl}

%% Deutsche Anpassungen %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage[ngerman]{babel}
\usepackage[T1]{fontenc}
\usepackage[ansinew]{inputenc}
\usepackage{lmodern} %Type1-Schriftart für nicht-englische Texte
\usepackage{booktabs}	% schönere tabellen

%% Packages für Grafiken & Abbildungen %%%%%%%%%%%%%%%%%%%%%%
\usepackage{graphicx} %%Zum Laden von Grafiken
%\usepackage{subfig} %%Teilabbildungen in einer Abbildung
%\usepackage{tikz} %%Vektorgrafiken aus LaTeX heraus erstellen


%% Packages für Formeln %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{amsfonts}


%% Andere Packages %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\usepackage{a4wide} %%Kleinere Seitenränder = mehr Text pro Zeile.
\usepackage{fancyhdr} %%Fancy Kopf- und Fußzeilen
%\usepackage{longtable} %%Für Tabellen, die eine Seite überschreiten
\usepackage{lastpage}
\usepackage[raggedright]{subfigure}
\usepackage[final]{pdfpages}
\includepdfset{pages=-,noautoscale}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% TODO
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 
% 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Optionen / Modifikationen
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\input{Einstellungen}

% Formeln römisch nummerieren
\renewcommand{\theequation}{\Roman{equation}} 

% "Formel" statt "Gleichung"
\def\equationname{Formel}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% DOKUMENT
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}

\title{RGB-LED}
\date{\today}
\author{Cyril Stoller, Marcel Bärtschi}
\maketitle

%% Inhaltsverzeichnis %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\tableofcontents %Inhaltsverzeichnis

\vfill

\listoffigures

%\pagestyle{fancy} %%Ab hier die Kopf-/Fusszeilen: headings / fancy / ...

\newpage

\begin{abstract}
	
\begin{center}	
\textbf{Abstract}
\vspace{0.3cm}

	Dieser Bericht dokumentiert die Hardware und Software unseres Projekts für das Modul "`Anwendungen Elektronischer Schaltungen"'. Die Vorgabe war, einen VHDL-Teil (implementiert auf dem Spartan 3E Development Board) und einen frei definierbaren analogen Teil zu planen und realisieren.
\end{center}
	
\end{abstract}

\vspace{2cm}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                                         %%
%%         Kapitel / Hauptteil des Dokumentes              %%
%%                                                         %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



\section{Einleitung}s
Wir haben uns dafür entschieden, eine RGB-LED im HSV-Farbraum\footnote{Siehe \url{https://de.wikipedia.org/wiki/HSV-Farbraum}} anzusteuern. Dazu soll mit dem Incremental Encoder der \emph{Hue}-Wert (Farbwert), mit den NORTH und SOUTH Tastern auf dem Spartan Board der \emph{Value}-Wert (Dunkelstufe) und mit den WEST und EAST Tastern der \emph{Saturation}-Wert (Sättigung) verändert werden können.

Der jeweilige Wert ist in 256 (acht Bit) Stufen einstellbar und wird im FPGA vom HSV- in den RGB-Farbraum umgerechnet. Danach werden diese drei Werte in Form eines PWM codierten Signals auf drei Ausgangspins ausgegeben und damit die rote, grüne und blaue LED gesteuert.

Auf der Hardwareseite schaltet das PWM Signal dann eine Stromquelle an welcher die LED angeschlossen ist.



\section{Software}

\subsection{Theorie}
Ein aktives Filter besteht aus einem OpAmp mit einer Beschaltung aus Kondensatoren und Widerständen. Dies bedeutet, dass das Filter an die Speisung angeschlossen ist. Verglichen mit dem passiven Filter (welches ausschliesslich aus diskreten Elementen wie Widerständen, Kondensatoren und Spulen besteht und nicht gespiesen wird) hat es die Vorteile, dass es einfacher höhere Ordnungen erzielen kann und eine Verstärkung beinhaltet.

\begin{figure}[!ht]
	\centering
		\includegraphics[width=0.65\textwidth]{images/Konzeptschema.pdf}
	\caption{Konzeptschema des Bandpasses zweiter Ordnung}
	\label{konzeptschema}
\end{figure}

Hier verwenden wir ein Bandpassfilter zweiter Ordnung (siehe \autoref{konzeptschema}). Der Verstärkerblock mit der Bezeichnung $\beta$ ist im Prinzip eine nicht-invertierende OpAmp-Verstärkerschaltung mit einer Offset-Kompensation, wobei die innere Verstärkung durch die Gegenkopplung realisiert ist.

\subsection{Dimensionierung}
Bei der Dimensionierung sind wir genau nach der Aufgabenstellung vorgegangen. Vorgegeben waren folgende Werte: $f_0$ = 1kHz, Q = 5, K = 25, C = 10nF
Da Q auch vorgegeben ist, können wir Bedingung \ref{bedingungK}\ (siehe Formel (9) in der Aufgabenstellung) prüfen, welche unter diesen Umständen erfüllt ist.

\begin{equation}
K > \sqrt{5} \cdot Q - 1
\label{bedingungK}
\end{equation}

\subsubsection{Beta}
Der zweite Schritt ist, die Verstärkung $\beta$ zu berechnen. Dies geschieht mit Formel \ref{beta}\ (siehe Formel (8) in der Aufgabenstellung), welche wir nach $\beta$ umgestellt haben. Dies ergibt zwei Lösungen, da die Gleichung vom Grad 2 ist. Laut der Aufgabenstellung ist es besser für die Empfindlichkeit den tieferen Wert der beiden zu wählen. So kommen wir auf $\beta$ = 2.53.

\begin{equation}
\beta^2 - \frac{2 \cdot K^2 + 2 \cdot K}{Q^2} \cdot \beta + \frac{5 \cdot K^2}{Q^2} = 0
\label{beta}
\end{equation}

\subsubsection{r}
Danach haben wir r aus Formel \ref{r}\ (siehe Formel (7) in der Aufgabestellung) berechnet. r ist einheitenlos und wird als Hilfgrösse zur Verhältnisberechnung der Widerstände verwendet. Es ergibt sich ein r von: r = 0.505

\begin{equation}
r = \frac{\beta \cdot Q}{K}
\label{r}
\end{equation}


\subsubsection{Widerstandswahl}
R1 nach Formel \ref{omega}\ (siehe Formel (6a) in der Aufgabenstellung) berechnen: R1 = 31.5k$\Omega$. Da die Kondensatoren vorgegeben sind (C = 10nF), existiert kein Freiheitsgrad mehr und die Widerstände können alle exakt berechnet werden.

\begin{equation}
 \omega_0 = \frac{1}{r \cdot R \cdot C}
 \label{omega}
\end{equation}

Um die Werte genau zu erreichen, haben wir bei den Widerständen R1 und R3 zusätzlich ein Potentiometer in Serie geschaltet (siehe \autoref{schema}). Somit bleibt einen gewisser Spielraum um die Schaltung später sauber abzustimmen.

\begin{description}
	\item[R0] 1k$\Omega$ (aus Unterlagen vorgegeben)

	\item[R1] (E12 Reihe) Serieschaltung $R_{11}$ + $R_{12}$, 27k$\Omega$ + 3.3k$\Omega$ erreicht (= 30.3k$\Omega$ statt 31.5k$\Omega$) Abweichung ist vernachlässigbar da die Mittenfrequenz auch mit R2 abgestimmt werden kann.

	\item[R2] (E12 Reihe) Serieschaltung R21 + R22, 6.8k$\Omega$ + 2k$\Omega$ Poti. Dadurch erreichen wir einen Abstimmbereich von 6.8k$\Omega$ bis 8.8k$\Omega$ bei einem Idealwert von 8.04k$\Omega$. Wenn sich der notwendige Bereich durch Ungenauigkeit verschoben hat, werden wir R21 variieren (z.B. auf 8.2k$\Omega$)
\end{description}

\subsubsection{Kondensatorwahl}
Bei dieser Wahl blieb nicht viel Spielraum übrig.

\begin{description}
	\item[C] = C1 = C2 = 10nF und C3 = $\frac{1}{2} C$ = 4.7nF

	\item[C3] ist um 300pF zu klein gewählt, da 5nF Kondensatoren nicht sehr handelsüblich sind. Man könnte den Wert verbessern, indem man einen 330pF Kondensator parallel schaltet, jedoch nehmen wir die Abweichung in Kauf und versuchen diese allenfalls bei der Abstimmung mit den Potis wieder wett zu machen.
\end{description}

\subsubsection{OpAmp Beschaltung}

\begin{description}
	\item[$R_{off}$] = 39k$\Omega$ (gewählt: 39k$\Omega$, E1 Reihe)

	\item[$R0 \cdot (\beta - 1)$] = 1.53k$\Omega$. Dieser	 ist aufgeteilt in $R_{01}$ und $R_{02}$. Serieschaltung 1k$\Omega$ + 2k$\Omega$ Potientiometer.
\end{description}

\begin{figure}[!ht]
	\centering
		\includegraphics[width=0.90\textwidth]{images/Schema.pdf}
	\caption{Schema für den Aufbau}
	\label{schema}
\end{figure}

\subsection{Simulation}
Die Simulation wurde in LT Spice durchgeführt. Da in der Aufgabenstellung der OpAmp LM741 vorgegeben ist, mussten wir diesen zuerst noch im Spice hinzufügen.
Danach wurde die Simulation gemäss dem Schema aufgebaut und die Werte entsprechend der Dimensionierung gewählt (siehe \autoref{pspice_schema}). Die Widerstände haben wir in der Simulation genau auf den berechneten Wert eingestellt. Bei der realen Schaltung haben wir einen Näherungswert genommen und mit einem Potentiometer in Serie zum Widerstand den Wert genau abgeglichen.

\begin{figure}[!ht]
	\centering
		\includegraphics[width=0.70\textwidth]{images/pspice_schema.pdf}
	\caption{Schema der Simulation im LT Spice}
	\label{pspice_schema}
\end{figure}

Das Ergebnis der Simulation in Abbildung \autoref{simulation_bode} stimmt recht genau mit dem gemessenen Ergebnis überein. Jedoch ist die Mittenfrequenz nicht genau gleich abgestimmt.

\begin{figure}[!ht]
	\centering
	\subfigure[Aplitude]{
		\includegraphics[width=0.80\textwidth]{images/simulation_amplitude.pdf}
	}
		\subfigure[Phase]{
		\includegraphics[width=0.80\textwidth]{images/simulation_phase.pdf}
	}	
	\caption{Bodediagramm der simulierten Filtercharakteristik}
	\label{simulation_bode}
\end{figure}

\subsection{Aufbau}
Der Aufbau auf der Steckplatte (\autoref{Aufbau}), hat uns am meisten Schwierigkeiten bereitet. Gleich zwei Mal hatten wir einen Fehler im Aufbau. 

\begin{figure}[!ht]
	\centering
		\includegraphics[width=0.80\textwidth]{images/Foto_2.JPG}
	\caption{Aufbau auf der Steckplatte}
	\label{Aufbau}
\end{figure}

\subsection{Abstimmung}
%\subsubsection{Mittenfrequenz}
Wir speisen am Eingang die Mittenfrequenz ein und messen am Ausgang die Phase. \autoref{bandpass} zeigt ein konzeptuelles Bodediagramm eines Bandpasses. Man kann gut sehen, dass die Amplitude in der Nähe der Mittenfrequenz recht flach ist, das heisst, schlecht abstimmbar. Laut dem erwarteten Phasengang eines Bandpasses wird sich dort die Phase aber schnell ändern und bei perfekter Abstimmung bei 45° sein. Deshalb werden wird den Bandpass über die Phasenverschiebung abstimmen.

\begin{figure}[!ht]
	\centering
		\includegraphics[width=0.55\textwidth]{images/bandpass.png}
	\caption[Konzeptuelles Bodediagramm eines Bandpasses]{Konzeptuelles Bodediagramm eines Bandpasses\cite{bandpass}}
	\label{bandpass}
\end{figure}

Für die Abstimmung haben wir die Widerstände R2 und R0 (siehe \autoref{schema}, bzw. \autoref{Aufbau}) mit Potentiometern ergänzt. Somit können wir mit dem Potentiometer $R_{02}$ die Verstärkung und mit $R_{22}$ die Phase (und somit die Mittenfrequenz) abstimmen.

\subsection{Messung}
Um zu schauen wie sich das Filter verhält und ob es gut dimensioniert ist, haben wir den Amplitudengang und den Phasengang gemessen (siehe \autoref{messung_bode}. Dabei haben wir vor allem im Bereich der Mittenfrequenz einige Punkte erfasst. 
Messmittelliste und Messtabelle sind im Anhang zu finden.

\begin{figure}[!ht]
	\centering
	\subfigure[Aplitude]{
		\includegraphics[width=0.80\textwidth]{images/messung_amplitude.pdf}
	}
		\subfigure[Phase]{
		\includegraphics[width=0.80\textwidth]{images/messung_phase.pdf}
	}	
	\caption{Bodediagramm der gemessenen Filtercharakteristik}
	\label{messung_bode}
\end{figure}

\subsection{Fehlerabschätzung}
Es ist recht schwer den Fehler abzuschätzen. Jedoch haben wir die Abstimmung recht gut hingekriegt, sodass die Mittenfrequenz sehr genau bei 1kHz liegt. Ob wir jedoch dabei immer noch die geforderte Verstärkung einhalten und die Güte noch stimmt, haben wir nicht so genau ermittelt. Dafür hat die Zeit nicht mehr gereicht. Aber wir können die Güte abschätzen, indem wir die Bandbreite herauslesen. Bei gegebener (abgestimmter) Mittenfrequenz kann man damit auf die Güte schliessen. Daraus erfolgt eine Güte von Q = 2.9, was doch ziemlich von den gewünschten 5 abweicht.

Bei der Verstärkung kommen wir auch nur auf einen Wert von 12.5 und liegen damit etwa um Faktor zwei daneben. Evtl. liegt hier ein Umrechnungsproblem bei von Spannung zu Dezibel vor.

\subsection{Diskussion}

\begin{figure}[!ht]
	\centering
		\includegraphics[width=0.8\textwidth]{images/Bodeplot_neu.pdf}
	\caption{Bodediagram}
	\label{Bodediagram}
\end{figure}

In den Grafiken bei \autoref{Bodediagram} sieht man schön, dass die Mittenfrequenz sauber auf 1kHz abgestimmt ist. Die Messung ist dabei sogar genauer als die Simulation. Dies liegt vermutlich daran, dass wir bei der Simulation die genau berechneten Werte für die Widerstände eingesetzt haben und diese nicht noch auf 1kHz abgestimmt haben.



\section{Schlussfolgerung}
Als Fazit können wir sagen, dass wir mit Hilfe der Anleitung die Dimensionierung gut durchführen konnten. Leider haben wir bei der Fehlersuche im Hardware-Aufbau viel Zeit verloren, die uns danach für die detaillierte Auswertung gefehlt hat. So hatten wir zum Beispiel keine Zeit mehr, die Güte anhand der Bandbreite und der Mittenfrequenz mit Messungen nachzukontrollieren.


\vfill
\begin{tabular}{rr}
	\\
	\\
	\\
	\\
	\toprule
	\scriptsize{Datum und Unterschrift}	\hspace{3cm}	&	\textsc{Marcel Bärtschi}	\\
	\\
	\\
	\\
	\\
	\toprule
	\scriptsize{Datum und Unterschrift}	\hspace{3cm}	&	\textsc{Cyril Stoller}
\end{tabular}


% Der Anhang kommt auf eine neue Zeile
\newpage
% Offizielle "A Anhang" Aufzählungsvariante
\appendix
% Nur im Inhaltsverzeichnis hinzufügen (mit richtiger Seite, da vorher "\newpage"), aber kein Text
\addcontentsline{toc}{section}{Anhang}

% Quellenverzeichnis
%\addcontentsline{toc}{section}{Quellenverzeichnis}
\section{Quellenverzeichnis}
\renewcommand\refname{}

\vspace{-1cm}

\bibliographystyle{amsplain}
\bibliography{Bildquellen}

\section{Messmittelliste}
\begin{itemize}
	\item Signalgenerator: HP 33120A (MG 231-2)
	\item Speisegerät: TTi PL320QMD (MN 221-4)
	\item Multimeter: HP 34401A (MM 319-2) (für RMS messungen)
	\item Phasemeter: BFH-eigenes Gerät
	\item KO:  Agilent DSO1022A (MK220-2)
	\item Multimeter: roline RO-334 (für Widerstände und Speisegerät Kontrolle)
\end{itemize}

\section{Messtabelle}

\begin{tabular}{|l|l|l|}
	\hline
	Frequenz in [Hz] & Amplitude EFF [mV] & Phase in [°] \\
	\hline
	\hline 200 &	87.6 & 70 \\
	\hline
	400	&84.9	&157 \\
	\hline
	600	&80.3	&307 \\
	\hline
	800	&68.3	&682 \\
	\hline
	850	&61.2	&886 \\
	\hline
	900	&49.7	&1190 \\
	\hline
	950	&29.6	&1599 \\
	\hline
	1000 &0	&1868 \\
	\hline
	1050 &-28.7	&1660 \\
	\hline
	1100 &-47	&1296 \\
	\hline
	1150 &-57.4	&1018 \\
	\hline
	1200 &-64.2	&828 \\
	\hline
	1400 &-75.5	&475 \\
	\hline
	1600 &-79.7	&338 \\
	\hline
	1800 &-81.9	&267 \\
	\hline
	2000 &-83.2 &222 \\
	\hline
	2200 &-84.1 &191 \\
	\hline
	\hline
\end{tabular}

\section{Matlab Code}

\section{Aufgabenstellung Praktikum}


\includepdf{MatlabSkript.pdf}
\includepdf{Praktikumsunterlagen.pdf}

\end{document}
