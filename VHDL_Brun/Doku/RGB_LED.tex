
%% Dokumenteinstellungen %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\documentclass[a4paper,oneside,12pt,ngerman]{scrartcl}

%% Deutsche Anpassungen %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage[ngerman]{babel}
\usepackage[T1]{fontenc}
\usepackage[ansinew]{inputenc}
\usepackage{lmodern} %Type1-Schriftart für nicht-englische Texte
\usepackage{booktabs}	% schönere tabellen

%% Packages für Grafiken & Abbildungen %%%%%%%%%%%%%%%%%%%%%%
\usepackage{graphicx} %%Zum Laden von Grafiken
%\usepackage{subfig} %%Teilabbildungen in einer Abbildung
%\usepackage{tikz} %%Vektorgrafiken aus LaTeX heraus erstellen


%% Packages für Formeln %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{amsfonts}


%% Andere Packages %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\usepackage{a4wide} %%Kleinere Seitenränder = mehr Text pro Zeile.
\usepackage{fancyhdr} %%Fancy Kopf- und Fußzeilen
%\usepackage{longtable} %%Für Tabellen, die eine Seite überschreiten
\usepackage{lastpage}
\usepackage[raggedright]{subfigure}
\usepackage[final]{pdfpages}
\includepdfset{pages=-,noautoscale}

\usepackage{listings}
\definecolor{bg}{rgb}{0.98,0.98,0.98}
\lstset{language=C,basicstyle=\small,keywordstyle=\color{violet},%
tabsize=2,backgroundcolor=\color{bg},numbers=left,%
basicstyle=\scriptsize\ttfamily,breaklines=true,breakatwhitespace=true}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% TODO
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 
% 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Optionen / Modifikationen
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\input{Einstellungen}

% Formeln römisch nummerieren
\renewcommand{\theequation}{\Roman{equation}} 

% "Formel" statt "Gleichung"
\def\equationname{Formel}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% DOKUMENT
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}

\title{Projektarbeit: High Power RGB-LED}
\date{\today}
\author{Cyril Stoller, Marcel Bärtschi}
\maketitle

%% Inhaltsverzeichnis %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\tableofcontents %Inhaltsverzeichnis

\vfill

\listoffigures

%\pagestyle{fancy} %%Ab hier die Kopf-/Fusszeilen: headings / fancy / ...

\newpage

\begin{abstract}
	
\begin{center}	
\textbf{Abstract}
\vspace{0.3cm}

	Um unsere Kentnisse in VHDL und im Entwerfen von elektronischen Schaltungen zu vertiefen, haben wir ein Projekt erarbeitet, in welchem wir beides gleichermassen üben können. Dabei ist das Projekt 40 Watt high power LED entstanden. 
\end{center}
	
\end{abstract}

\vspace{2cm}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                                         %%
%%         Kapitel / Hauptteil des Dokumentes              %%
%%                                                         %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



\section{Ziel}
\begin{quote}
Es gibt nichts Praktischeres als eine gute Theorie.

Immanuel Kant (1724 - 1804), deutscher Philosoph
\end{quote}
Um trotzdem mal selbst Hand anzulegen, ist ein Projekt zu erarbeiten, dass einen digitalen und einen analogen Teil enthält. Der zeitliche Rahmen ist auf ein halbes Semester begrenzt. 
Der digitale Teil soll mit einem Spartan 3E Board in VHDL realisiert werden. Für den analogen Teil sind keine Vorgaben vorhanden.

\section{Einleitung}
Wir haben uns dafür entschieden, eine RGB-LED im HSV-Farbraum\footnote{Siehe \url{https://de.wikipedia.org/wiki/HSV-Farbraum}} anzusteuern.

Dazu sollen mit dem Dreh-Encoder und vier Tastern die drei Werte \emph{Hue} (Farbwert), \emph{Value} (Dunkelstufe) und \emph{Saturation} (Sättigung) verändert werden können.

\begin{figure}[ht]
	\centering
		\includegraphics[width=0.70\textwidth]{images/Blockschaltbild_grob.pdf}
	\caption{Grobes Blockschaltbild der Idee}
	\label{fig:Blockschaltbild_grob}
\end{figure}


Der jeweilige Wert ist in 256 (acht Bit) Stufen einstellbar und wird im FPGA vom HSV- in den RGB-Farbraum umgerechnet. Danach werden diese drei Werte in Form eines PWM codierten Signals auf drei Ausgangspins ausgegeben und damit die rote, grüne und blaue LED angesteuert. Auf der Hardwareseite schaltet das PWM Signal dann eine Stromquelle, an welcher die LED angeschlossen ist. Das Blockschema ist dargestellt in \autoref{fig:Blockschaltbild_grob}.

Im folgenden werden die beiden Teilprojekte \emph{Digitalteil} und \emph{Analogteil} genauer erläutert.

\section{Digitalteil}

Für den Digitalteil nutzen wir das Entwicklungsboard Spartan-3E Starterkit. Darauf benötigen wir wie schon erwähnt den Drehencoder, die vier Taster darum herum und drei I/O Pins rechts unten. Die Position der Elemente ist auf \autoref{fig:Software-Hardware} sichtbar.

\begin{figure}[ht]
	\centering
		\includegraphics[width=0.70\textwidth]{images/Software-Hardware.pdf}
	\caption{Beschreibung der Ein- und Ausgänge auf dem Digitalteil}
	\label{fig:Software-Hardware}
\end{figure}

\subsection{Grobe Datenverarbeitung}

Der VHDL Code ist ein klassischer Fall von einem Input$\rightarrow$Processing$\rightarrow$Output System (\autoref{fig:Software}. Als Eingang fungieren drei einstellbare Werte - der Hue-Wert, der Saturation-Wert und der Value-Wert.

Der Hue-Wert wird mit dem Drehencoder schrittweise zwischen 0 und 383 verändert. Die vier Taster dienen je zu zweit ebenfalls der Einstellung je eines Wertes. Jedoch wurde hier die Entscheidung getroffen, vor dem Zählermodul noch ein Autorepeat einzufügen (in der Grafik nicht dargestellt), da es kaum nötig sein wird, die Sättigung oder die Helligkeit in einzelnen Schritten von 0 bis 255 zu ändern.

\begin{figure}[ht]
	\centering
		\includegraphics[width=1.00\textwidth]{images/Software.pdf}
	\caption{Blockschaltbild des Digitalteils}
	\label{fig:Software}
\end{figure}

Die drei Zählermodule benötigen am Eingang jeweils einen UP- und einen DOWN-Trigger. Im Falle der Taster (Saturation und Value Werte) kommen diese Signale dann auf ein Autorepeat-Modul. Dieses schaut am Eingang ob einer der beiden Triggersignale 1 ist. Wenn dies der Fall ist, fängt es nach einer gewissen Zeit ($2.6ms$) an, den jeweiligen Ausgang zu toggeln, welcher dann den Zähler kontinuierlich erhöht oder verringern. Im Fall des Drehencoders haben wir uns entschieden, die Schritte direkt zum Zählermodul zu führen. Jedoch müssen natürlich die beiden Eingangspins des Drehencoders zuerst decodiert werden.

Danach werden die drei Werte in einem Modul vom HSV in dn RGB Farbraum konvertiert und anschliessend über je ein PWM Encoder Modul auf die drei Ausgangspins gesendet.

\subsection{HSV-RGB-Encoder}

Der HSV-Farbraum (Abbildung \ref{fig:HSV}) und der RGB-Farbraum (Abbildung \ref{fig:RGB}) sind verwandt und dadurch relativ einfach umrechenbar.

\begin{figure}[ht]
	\centering
		\subfigure[HSV Farbraum]{
			\includegraphics{images/HSV.png}
			\label{fig:HSV}
		}
		\subfigure[RGB Farbraum]{
			\includegraphics{images/RGB.png}
			\label{fig:RGB}
		}
\end{figure}

Eine grafische Darstellung der Umrechnung ist in \autoref{fig:RGB-HSV} dargestellt. 
Die Formeln dazu sind in Formel \ref{formel:a}, \ref{formel:b} und \ref{formel:c} ersichtlich.

Dabei gibt es vor allem ein Problem: In VHDL kann man nicht durch 60 teilen. Darum haben wir uns entschieden, die "`Breite"' des HSV-Wertes von $360^\circ$ auf $384^\circ$ erhöht. Somit sind die sechs Teilbereiche die in Formel \ref{formel:c} dargestellt sind, jeweils 64 lang. Also kann mit 64 dividiert werden, was in VHDL einem schieben nach rechts um sechs Bit gleichkommt.

\begin{figure}[ht]
	\centering
		\includegraphics[width=0.6\textwidth]{images/RGB-HSV.png}
	\caption{HSV-RGB Konvertierung}
	\label{fig:RGB-HSV}
\end{figure}

\begin{align}
	\label{formel:a}
	h_\mathrm{i} &:= \left \lfloor { \frac{H}{60^\circ} } \right \rfloor;\;\;\;f:= \left(\frac{H}{60^\circ} - h_\mathrm{i}\right) \\
	%
	\label{formel:b}
	p &:= V \cdot (1 - S);\quad q:= V \cdot (1 - S \cdot f );\quad t:= V \cdot \left( 1 - S \cdot (1 - f) \right) \\
	%
	\label{formel:c}
	(R,G,B) &:=
    \begin{cases}
        (V,t,p), \text{falls } h_\mathrm{i} \in \{0,6\} \\
        (q,V,p), \text{falls } h_\mathrm{i} = 1 \\
        (p,V,t), \text{falls } h_\mathrm{i} = 2 \\
        (p,q,V), \text{falls } h_\mathrm{i} = 3 \\
        (t,p,V), \text{falls } h_\mathrm{i} = 4 \\
        (V,p,q), \text{falls } h_\mathrm{i} = 5
    \end{cases}
\end{align}

Der Code ist in einem einzigen Prozess enthalten, welcher laufend die drei Eingangswerte umrechnet und auf die drei Ausgangsvektoren schreibt:

\begin{lstlisting}[frame=single]
if SAT = "00000000" then
	R <= VAL;
	G <= VAL;
	B <= VAL;
else
	base := (("11111111" - unsigned(SAT)) * unsigned(VAL)) srl 8;
	switch := unsigned(HUE) srl 6;
	case switch(2 downto 0) is
		when "000" =>
			R <= VAL;
			led_value := (((unsigned(VAL) - base(7 downto 0)) * unsigned(HUE)) srl 6) + base(7 downto 0);
			G <= std_logic_vector(led_value(7 downto 0));
			B <= std_logic_vector(base(7 downto 0));
		
		when "001" =>
			led_value := (((unsigned(VAL) - base(7 downto 0)) * ("001000000"-(unsigned(HUE) mod "001000000"))) srl 6) + base(7 downto 0);
			R <= std_logic_vector(led_value(7 downto 0));
			G <= VAL;
			B <= std_logic_vector(base(7 downto 0));
		
		when "010" =>
			R <= std_logic_vector(base(7 downto 0));
			G <= VAL;
			led_value := (((unsigned(VAL) - base(7 downto 0)) * (unsigned(HUE) mod "001000000")) srl 6) + base(7 downto 0);
			B <= std_logic_vector(led_value(7 downto 0));
		
		when "011" =>
			R <= std_logic_vector(base(7 downto 0));
			led_value := (((unsigned(VAL) - base(7 downto 0)) * ("001000000"-(unsigned(HUE) mod "001000000"))) srl 6) + base(7 downto 0);
			G <= std_logic_vector(led_value(7 downto 0));
			B <= VAL;
		
		when "100" =>
			led_value := (((unsigned(VAL) - base(7 downto 0)) * (unsigned(HUE) mod "001000000")) srl 6) + base(7 downto 0);
			R <= std_logic_vector(led_value(7 downto 0));
			G <= std_logic_vector(base(7 downto 0));
			B <= VAL;
		
		when "101" =>
			R <= VAL;
			G <= std_logic_vector(base(7 downto 0));
			led_value := (((unsigned(VAL) - base(7 downto 0)) * ("001000000"-(unsigned(HUE) mod "001000000"))) srl 6) + base(7 downto 0);
			B <= std_logic_vector(led_value(7 downto 0));
			
		when others =>
			R <= "00000000";
			G <= "00000000";
			B <= "00000000";
	end case;
end if;
\end{lstlisting}


- erklärung, warum beim hue wert nicht 8 bit sondern 9 bit (und 384 schritte) gewählt wurden: damit der hue wert auf 6 teil bereiche mit jeweils einer breite mit einer zweierpotenz zerlegbar ist (division durch 64 -> 6 bit nach rechts geschoben)
- system nach fallunterscheidung (6 teilbereiche)



\subsection{Inkremental-Decoder}

- Darstellung der beiden Eingagnssignale (mit schön dasrgestelter phasenverschiebung) -> aus spartan pdf\\
- Softeware erklärung (evtl. mit state event diagramm)\\
- bild vom drehencoder -> CCW und CW erklären, wieviele steps pro 1 umdrehung -> wieviele umdrehungen für ganzer HSV farbraum\\
- Darstellung vom simulator

\begin{figure}[ht]
	\centering
		\includegraphics{images/Rotary_signals.png}
	\caption{Ausgangssignale des Dreh-Encoders}
	\label{fig:Rotary_signals}
\end{figure}


\subsection{Up-Down Counter}

- counter erklären\\
- erklären, wieso es 256 und 384 gibt, auch warum der 256 NICHT überlaufen darf aber der 384 überlaufen MUSS\\
- Darstellung vom simulator	

\subsection{PWM-Encoder}

- basics eines PWM signals\\
- berechnung der maximalen / minimalen PWM grundtaktfrequenz (argumente: schnell schalten = mehr schaltverluste am FET; langsam schalten = flackern vom auge sichtbar)\\
- basics für look-up-table - formel von Mikrocontroller.net: \url{http://www.mikrocontroller.net/articles/LED-Fading}\\
- array in vhdl

\begin{figure}[ht]
	\centering
		\includegraphics{images/Logarithmiktabelle.png}
	\caption{Logarithmik Umrechnung}
	\label{fig:Logarithmiktabelle}
\end{figure}


\section{Analogteil}
Im analogen Teil des Projekts gings darum, eine high power RGB LED mit einer möglichst effizienten Schaltung anzusteuern.
\subsection{Bauteilspezifikation}
Bei der Evaluation der LED war die Leistung unser Hauptkriterium. 
\subsubsection{RGB-LED}

\subsubsection{Stromquelle}

\subsection{Kühlkörperdimensionierung}

\subsection{Hardwareaufbau}

\section{Inbetriebnahme}

\section{Schlussfolgerung}


\vfill
\begin{tabular}{rr}
	\\
	\\
	\\
	\\
	\toprule
	\scriptsize{Datum und Unterschrift}	\hspace{3cm}	&	\textsc{Marcel Bärtschi}	\\
	\\
	\\
	\\
	\\
	\toprule
	\scriptsize{Datum und Unterschrift}	\hspace{3cm}	&	\textsc{Cyril Stoller}
\end{tabular}


% Der Anhang kommt auf eine neue Zeile
\newpage
% Offizielle "A Anhang" Aufzählungsvariante
\appendix
% Nur im Inhaltsverzeichnis hinzufügen (mit richtiger Seite, da vorher "\newpage"), aber kein Text
\addcontentsline{toc}{section}{Anhang}

% Quellenverzeichnis
%\addcontentsline{toc}{section}{Quellenverzeichnis}
\section{Quellenverzeichnis}
\renewcommand\refname{}

\vspace{-1cm}

\bibliographystyle{amsplain}
\bibliography{Bildquellen}

\end{document}
